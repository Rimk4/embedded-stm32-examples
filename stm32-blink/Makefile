# Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ STM32 –ø—Ä–æ–µ–∫—Ç–∞

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
TARGET = stm32-blink
MCU = cortex-m4
FPU = fpv4-sp-d16

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
PREFIX = arm-none-eabi-
CC = $(PREFIX)gcc
OBJCOPY = $(PREFIX)objcopy
OBJDUMP = $(PREFIX)objdump
SIZE = $(PREFIX)size
GDB = $(PREFIX)gdb
OPENOCD = openocd
STFLASH = st-flash
RM = rm -f
MKDIR = mkdir -p

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SRC_DIR = src
LINKER_DIR = linker
BUILD_DIR = build

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
SOURCES = $(SRC_DIR)/main.c \
          $(SRC_DIR)/gpio.c \
          $(SRC_DIR)/delay.c \
          $(SRC_DIR)/startup.c

OBJECTS = $(SOURCES:$(SRC_DIR)/%.c=$(BUILD_DIR)/%.o)

# –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è Cortex-M4 —Å FPU
BASE_FLAGS = -mcpu=$(MCU) -mthumb
BASE_FLAGS += -mfloat-abi=hard -mfpu=$(FPU)

# –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ - –î–û–ë–ê–í–õ–ï–ù -g –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
CFLAGS = $(BASE_FLAGS)
CFLAGS += -Og -Wall -Wextra  # -Og –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Ç–ª–∞–¥–∫–∏
CFLAGS += -g3                # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
CFLAGS += -ffunction-sections -fdata-sections
CFLAGS += -nostdlib -nostartfiles
CFLAGS += -I$(SRC_DIR)       # –î–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
CFLAGS += -MMD -MP

# –§–ª–∞–≥–∏ –ª–∏–Ω–∫–æ–≤–∫–∏
LDFLAGS = $(BASE_FLAGS)
LDFLAGS += -T $(LINKER_DIR)/stm32f407.ld
LDFLAGS += -Wl,-Map=$(BUILD_DIR)/$(TARGET).map
LDFLAGS += -Wl,--gc-sections
LDFLAGS += -specs=nano.specs
LDFLAGS += -Wl,--print-memory-usage

# –¶–≤–µ—Ç–∞
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[0;33m
BLUE = \033[0;34m
NC = \033[0m

.PHONY: all clean flash stflash openocd debug info check help

all: $(BUILD_DIR)/$(TARGET).elf $(BUILD_DIR)/$(TARGET).bin
	@echo "$(GREEN)‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"

help:
	@echo "$(BLUE)–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏:$(NC)"
	@echo "  make all     - —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
	@echo "  make clean   - –æ—á–∏—Å—Ç–∏—Ç—å"
	@echo "  make flash   - –ø—Ä–æ—à–∏—Ç—å —á–µ—Ä–µ–∑ OpenOCD"
	@echo "  make stflash - –ø—Ä–æ—à–∏—Ç—å —á–µ—Ä–µ–∑ st-flash"
	@echo "  make debug   - –æ—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ GDB"
	@echo "  make info    - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ELF"

$(BUILD_DIR):
	@$(MKDIR) $(BUILD_DIR)

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c | $(BUILD_DIR)
	@echo "$(YELLOW)üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è: $<$(NC)"
	@$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/$(TARGET).elf: $(OBJECTS)
	@echo "$(YELLOW)üîó –õ–∏–Ω–∫–æ–≤–∫–∞: $@$(NC)"
	@$(CC) $(OBJECTS) $(LDFLAGS) -o $@
	@$(SIZE) $@

$(BUILD_DIR)/$(TARGET).bin: $(BUILD_DIR)/$(TARGET).elf
	@$(OBJCOPY) -O binary $< $@
	@echo "$(GREEN)‚úÖ BIN: $$(stat -c%s $@) –±–∞–π—Ç$(NC)"

clean:
	@$(RM) -r $(BUILD_DIR)
	@echo "$(GREEN)‚úÖ –û—á–∏—â–µ–Ω–æ$(NC)"

stflash: $(BUILD_DIR)/$(TARGET).bin
	@$(STFLASH) --reset write $(BUILD_DIR)/$(TARGET).bin 0x08000000

flash: $(BUILD_DIR)/$(TARGET).bin
	openocd -f interface/stlink.cfg \
	        -f target/stm32f4x.cfg \
	        -c "program $(BUILD_DIR)/$(TARGET).bin 0x08000000 verify reset exit"

debug: $(BUILD_DIR)/$(TARGET).elf
	@echo "$(YELLOW)–ó–∞–ø—É—Å–∫ GDB...$(NC)"
	$(GDB) -ex "target remote localhost:4242" \
	       -ex "monitor reset halt" \
	       -ex "load" \
	       -ex "b main" \
	       -ex "continue" \
	       $(BUILD_DIR)/$(TARGET).elf

info: $(BUILD_DIR)/$(TARGET).elf
	$(PREFIX)readelf -h $<
	$(OBJDUMP) -h $<

-include $(OBJECTS:.o=.d)
